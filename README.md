# GCP Identity Platform Go Microservice

This microservice provides user authentication using Google Cloud Identity Platform (not Firebase Auth) with Go and Fiber.

## Features
- Clean architecture (handlers, service, model)
- REST endpoint for user login and sign up
- Docker and Docker Compose support

## Prerequisites
1. Identity Platform enabled: In Google Cloud Console → Identity Platform → Enable.
2. An email/password provider enabled: Go to Identity Platform → Authentication → Sign-in method
- Enable Email/Password.

You don’t need a service account for any of this.

## Requirements
- Go 1.21+
- Docker (optional, for containerized runs)
- [Google Cloud Identity Platform](https://cloud.google.com/security/products/identity-platform?hl=en) enabled and API key

## Supported user authentication methods (no service accounts needed)
With Identity Platform, you can authenticate users directly using:
- Email and password
- Identity Platform handles sign-up, login, password reset, etc.

You don’t need a service account for any of this.

## Create an API key on [Google Cloud](https://cloud.google.com/docs/authentication/api-keys#create) 
1. In the Google Cloud console, go to the [Credentials page](https://console.cloud.google.com/apis/credentials)
2. Go to Credentials
3. Click Create credentials, and then select API key from the menu.
```
Optional: To bind the API key to a service account, select the Authenticate API calls through a service account checkbox and then click Select a service account to select the service account you want to bind to the key.
For more information, see API keys bound to a service account.
```
4. Add API key restrictions.
5. Restricting API keys is a best practice. For more information, see Apply API key restrictions.
6. Click Create. The API key created dialog displays the string for your newly created key.

## Usage

### Using the [REST API](https://cloud.google.com/identity-platform/docs/use-rest-api#before_you_begin)
To use the REST API, you'll need an Identity Platform API key. To obtain a key:

1. Go to the Identity Providers page in the Google Cloud console.
2. Go to the Identity Providers page.
3. Click Application setup details.
4. Copy the apiKey field.

### 1. Set your GCP Identity Platform API Key
Export your API key as an environment variable:

```sh
export GCP_IDENTITY_API_KEY=your_api_key_here
export GCP_PROJECT_ID=your_project_id_here
```

### 2. Run Locally

```sh
go run ./cmd/main.go
```

### 3. Run with Docker Compose(Recommended option)

```sh
docker-compose up --build
```

### 4. Authenticate User (Login)

Send a POST request to `/login`:

```sh
curl -X POST http://localhost:8080/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"yourpassword"}'
```

Replace the email and password with real credentials.

### 5. Register User (Sign Up)

Send a POST request to `/signup`:

```sh
curl -X POST http://localhost:8080/signup \
  -H "Content-Type: application/json" \
  -d '{"email":"newuser@example.com","password":"newpassword"}'
```

### 6. Validate ID Token

Send a POST request to `/validate-token`:

```sh
curl -X POST http://localhost:8080/validate-token \
  -H "Content-Type: application/json" \
  -d '{"idToken":"YOUR_GCP_TOKEN"}'
```

### 7. Sign In With Custom Token

Send a POST request to `/custom-token`:

```sh
curl -X POST http://localhost:8080/custom-token \
  -H "Content-Type: application/json" \
  -d '{"customToken":"YOUR_CUSTOM_TOKEN"}'
```
### 8. Decode JWT Token

Send a POST request to `/decode-token`:

```sh
curl -X GET "http://localhost:8080/secure/decode-token" \
  -H "Authorization: Bearer <YOUR_GCP_TOKEN>"
```

### 9. Get Public Key in PEM Format

Send a GET request to `/secure/public-key` with a valid GCP ID token:

```sh
curl -X GET http://localhost:8080/secure/public-key \
  -H "Authorization: Bearer <YOUR_GCP_TOKEN>"
```

Response:
```
{
  "n": "<RSA modulus>",
  "pem_format": "-----BEGIN PUBLIC KEY-----...-----END PUBLIC KEY-----"
}
```

## Project Structure

- `cmd/main.go` — Application entrypoint
- `internal/handler/` — HTTP/Fiber handlers
- `internal/service/` — Business logic
- `internal/model/` — Data models

## License
MIT

### Encode or Decode JWTs
https://www.jwt.io/

### JSON Web Token (JWT) Debugger

To verify or decode a token generated by GCP Identity Platform (Google Identity Platform), you typically need the [public keys](https://www.googleapis.com/robot/v1/metadata/x509/securetoken@system.gserviceaccount.com) Google uses to sign those tokens. These tokens are OIDC (OpenID Connect) ID tokens or JWTs, and Google publishes the public keys at a known endpoint.

#### JWT Info

```
HEADER {
  alg: The algorithm used to sign the JWT.
  kid: The key ID is a hint indicating which key was used to secure the JWS.
  typ: The media type of this complete JWT. 
}

PAYLOAD {
  iss: The issuer of the JWT. 
  aud: The recipients that the JWT is intended for. 
  auth_time: The time when the End-User authentication occurred. This value must be a NumericDate type, representing seconds.
  sub: The subject of the JWT (the user). 
  iat: The time at which the JWT was issued. 
}
```

## FAQs

### Can we authenticate users on the GCP identity platform without using service accounts?
```
Yes — you can authenticate users on Google Cloud Platform’s Identity Platform (now part of Firebase Authentication) without using service accounts.
A service account is used for server-to-server authentication — for example, when your backend talks to Google APIs.
But if you’re building an app where end users log in (with email/password, OAuth, SAML, OIDC, etc.), you don’t need a service account for that. You rely on Identity Platform’s user authentication mechanisms instead.
```

### Can we authenticate users on GCP Identity Platform without using service accounts and projects?
```
No, you cannot use Identity Platform without a Google Cloud project and,
You can authenticate users without a service account, but a GCP project is always required.
```

### Why GCP tokens are signed by a service account
```
Google Cloud Platform (GCP) tokens, especially ID tokens and access tokens used in authentication 
and authorization are often signed by service accounts for several important reasons:

1. Delegated Trust and Identity
Service accounts in GCP represent non-human identities (e.g., apps, services, VMs). 
When a token is signed by a service account:
- It asserts that the token was issued by a trusted identity within the GCP ecosystem.
- The signature can be verified using the public key associated with that service account.

2. Token Verification
Tokens signed by service accounts can be:
- Verified by other services using the public key from the service account’s certificate.
- Used to authenticate the identity of the caller (e.g., a microservice calling another microservice).

3. Security and Isolation
Using service accounts to sign tokens:
- Limits the scope of access.
- Ensures that only authorized services can issue tokens.
- Helps with auditing and access control.

In summary, generating a JWT signed with a private key for use with Google Cloud Platform (GCP) 
services typically involves using a service account and its associated private key.

```


